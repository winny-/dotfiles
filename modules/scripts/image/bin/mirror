#!/usr/bin/env python3
import mpv
import click
import os
import sys
import time
from PIL import Image, ImageDraw, ImageFont


def my_log(loglevel, component, message):
    print('[{}] {}: {}'.format(loglevel, component, message))

@click.command()
@click.option('--source', '-s', type=click.Path(exists=True), default='/dev/video0')
def mirror(source):
    player = mpv.MPV(
        log_handler=my_log,
        input_default_bindings=False,
        input_builtin_bindings=False,
        input_vo_keyboard=True,
    )

    player.fullscreen = True

    # Minimal latency, please!
    player.profile = 'low-latency'
    player['untimed'] = True

    flipped = False

    @player.on_key_press('esc')
    @player.on_key_press('q')
    def quit():
        player.stop()

    @player.on_key_press('f')
    def flip_horiz():
        nonlocal flipped
        flipped = not flipped
        player.command('vf', 'toggle', 'hflip')

    @player.on_key_press('F')
    def flip_vert():
        player.command('vf', 'toggle', 'vflip')

    @player.on_key_press('s')
    def screenshot():
        player.command('screenshot')

    @player.on_key_press('B')
    def do_breakpoint():
        if not os.isatty(sys.stdin.fileno()):
            return
        nonlocal player
        player.window_minimized = True
        breakpoint()

    player.play(source)
    player.wait_until_playing()

    font = ImageFont.truetype('DejaVuSans.ttf', 50)

    while not player.core_idle:
        overlay = player.create_image_overlay()
        right_img = Image.new('RGBA', (50, 50), (255, 255, 255, 0))
        right_draw = ImageDraw.Draw(right_img)
        right_draw.text((0, 0), 'R', font=font)
        right_x = player.osd_width - right_img.width if flipped else 0
        overlay.update(right_img, pos=(right_x, player.osd_height - right_img.height))
        time.sleep(0.5)
        overlay.remove()

    del player


if __name__ == '__main__':
    mirror()
