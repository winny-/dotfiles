#!/usr/bin/env python3
"""Originally adapted from
https://www.reddit.com/r/kde/comments/176yfir/kde_auto_switch_light_to_dark_color_schemes_night/
with added Bashisms, then later rewritten in Python.

KDE 6.5 offers a dark mode switch in "Global Theme" settings.  XXX rely on KDE
native dark mode machinery and hook into this automatic change so Alacritty's
symlink updates.

"""
import click
import re
import sh
import os
import tomllib
from xdg import BaseDirectory
from datetime import datetime, UTC
from pathlib import Path
from io import StringIO
import enum
from suntime import Sun


plasma_apply_colorscheme = sh.Command('plasma-apply-colorscheme')
plasma_changeicons = sh.Command(
    # XXX Should not hardcode abspath to libexec.
    '/usr/lib/x86_64-linux-gnu/libexec/plasma-changeicons'
)


class ColorMode(enum.Enum):
    LIGHT = enum.auto()
    DARK = enum.auto()


def hhmm_today(hhmm: str) -> datetime:
    """Parse a HH:MM string and return a datetime with today's date and the
    specified time."""
    converted = datetime.strptime(hhmm, '%H:%M')
    return datetime.now().replace(hour=converted.hour,
                                  minute=converted.minute)


@click.command
@click.option('--dump-config', '-d', is_flag=True, default=False,
              help='Dump configuration and exit.')
@click.argument('mode',
                type=click.Choice('auto light dark'.split(),
                                  case_sensitive=False),
                default='auto')
def main(dump_config, mode):
    """Switch between light or dark mode.  Defaults to auto."""
    # Ensure any external commands output in Locale agnostic output.
    os.environ['LANG'] = os.environ['LC_ALL'] = 'C'
    config_path = (
        Path(BaseDirectory.save_config_path('lightdark'))
        / 'config.toml'
    )
    with open(config_path, 'rb') as f:
        cfg = tomllib.load(f)
    requested_mode = None
    loc_cfg = cfg['location']
    long, lat = float(loc_cfg['long']), float(loc_cfg['lat'])
    local_tz = datetime.now(UTC).astimezone().tzinfo
    now = datetime.now(local_tz)
    sun = Sun(long, lat)
    # These lines probably will need updating soon...
    sunrise = sun.get_local_sunrise_time(local_time_zone=local_tz)
    sunset = sun.get_local_sunset_time(local_time_zone=local_tz)
    match mode:
        case 'auto':
            if sunrise <= now < sunset:
                requested_mode = ColorMode.LIGHT
            else:
                requested_mode = ColorMode.DARK
        case 'light' | 'dark':
            requested_mode = ColorMode[mode.upper()]
        case _:
            raise ValueError(f'Unknown mode selector {mode}')
    if dump_config:
        click.echo(f'Time:      {now:%H:%M:%S}')
        click.echo(f'Long, lat: {long}, {lat}')
        click.echo(f'Sunrise:   {sunrise:%H:%M:%S}')
        click.echo(f'Sunset:    {sunset:%H:%M:%S}')
        click.echo(f'Mode:      {mode.lower()} -> {requested_mode.name.lower()}')
        exit()
    set_mode(requested_mode)


def set_mode(mode: ColorMode):
    """Set light or dark mode."""
    update_alacritty_theme(mode)
    match mode:
        case ColorMode.LIGHT:
            plasma_apply_colorscheme('BreezeLight')
            plasma_changeicons('breeze')
        case ColorMode.DARK:
            plasma_apply_colorscheme('BreezeDark')
            plasma_changeicons('breeze-dark')
        case unknown:
            raise ValueError(f'Do not know what to do with {unknown}')


# XXX Dead code, do I need this?
def current_qt_theme() -> str:
    """Get current QT Theme."""
    buf = StringIO()
    plasma_apply_colorscheme('--list-schemes', _out=buf)
    output = buf.getvalue()
    m = re.search(r'^ \* ([^ ]+) \(current color scheme\)',
                  output,
                  re.M)
    if not m:
        s = f'Bad output from plasma-apply-colorscheme (got {output[:30]}â€¦)'
        raise ValueError(s)
    return m.group(1)


def update_alacritty_theme(mode: ColorMode):
    symlink = Path("~/.config/alacritty/current-theme.toml").expanduser()
    alacritty_cfgdir = symlink.parent
    target_base = Path(f'{mode.name.lower()}-theme.toml')
    target = alacritty_cfgdir / target_base
    prefix = 'Skipping alacritty support: '
    if not alacritty_cfgdir.is_dir():
        s = f"{prefix}directory {alacritty_cfgdir} does not exist"
        click.echo(s, err=True)
        return
    if not target.exists():
        s = f"{prefix}symlink target {target} does not exist"
        click.echo(s, err=True)
        return
    resolved = symlink.resolve()
    if not resolved.exists() or resolved != target.resolve():
        symlink.unlink(missing_ok=True)
        symlink.symlink_to(target)


if __name__ == '__main__':
    main()
